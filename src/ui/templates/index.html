<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        surface: {
                            50: '#fafafa',
                            100: '#f4f4f5',
                            200: '#e4e4e7',
                            300: '#d4d4d8',
                            400: '#a1a1aa',
                            500: '#71717a',
                            600: '#52525b',
                            700: '#3f3f46',
                            800: '#27272a',
                            900: '#18181b',
                            950: '#09090b',
                        },
                        accent: {
                            DEFAULT: '#6366f1',
                            hover: '#818cf8',
                            muted: '#4f46e5'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }

        /* Markdown Styles */
        .prose pre {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            margin: 12px 0;
        }
        .prose code {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 13px;
        }
        .prose p { margin-bottom: 8px; }
        .prose ul, .prose ol { margin-left: 20px; margin-bottom: 8px; }
        .prose h1, .prose h2, .prose h3 { font-weight: 600; margin: 16px 0 8px; }
        .prose a { color: #818cf8; }
        .prose a:hover { text-decoration: underline; }

        /* Auto-resize textarea */
        .chat-textarea {
            resize: none;
            overflow-y: hidden;
            line-height: 1.5;
        }
        .chat-textarea:focus {
            outline: none;
        }

        /* Animations */
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-subtle {
            animation: pulse-subtle 2s ease-in-out infinite;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slideIn {
            animation: slideIn 0.2s ease-out;
        }

        /* Session item hover */
        .session-item {
            transition: all 0.15s ease;
        }
        .session-item:hover {
            background: #27272a;
        }
        .session-item.active {
            background: #3f3f46;
            border-left: 2px solid #6366f1;
        }

        /* Hide copy button while AI is responding */
        .typing-cursor ~ button {
            display: none !important;
        }
    </style>
</head>

<body class="bg-surface-950 h-screen flex overflow-hidden text-surface-200">
    
    <!-- Sidebar -->
    <aside class="w-72 bg-surface-900 border-r border-surface-800 flex flex-col flex-shrink-0">
        
        <!-- Logo & New Chat -->
        <div class="p-4 border-b border-surface-800">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-base font-semibold text-white">문서 어시스턴트</h1>
                {% if user %}
                <div class="flex items-center gap-2">
                    <span class="text-xs text-surface-400">{{ user.username }}</span>
                    <button onclick="logout()" class="text-surface-500 hover:text-red-400 transition-colors" title="로그아웃">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
                {% else %}
                <button onclick="openLoginModal()" class="text-xs text-accent hover:text-accent-hover transition-colors">로그인</button>
                {% endif %}
            </div>
            <button onclick="clearChat()" class="w-full py-2.5 px-4 bg-surface-800 hover:bg-surface-700 text-surface-200 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 border border-surface-700 hover:border-surface-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                새 대화
            </button>
        </div>

        <!-- Settings Sections -->
        <div class="flex-1 overflow-y-auto p-4 space-y-5">
            
            <!-- Model Section -->
            <section>
                <label class="block text-[11px] font-medium text-surface-500 uppercase tracking-wider mb-2">모델</label>
                <div class="flex gap-2">
                    <select id="modelSelect" onchange="loadModel()" class="flex-1 px-3 py-2 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 focus:outline-none focus:border-accent transition-colors">
                        <option value="">{% if models %}모델 선택{% else %}설치된 모델 없음{% endif %}</option>
                        {% for model in models %}
                        <option value="{{ model.name }}" data-vision="{{ model.is_vision }}">
                            {{ model.name }} ({{ model.size }}){% if model.is_vision %} [V]{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <button onclick="openModelManager()" class="p-2 bg-surface-800 border border-surface-700 rounded-lg text-surface-400 hover:text-white hover:border-surface-600 transition-all" title="모델 관리">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                </div>
                <div id="modelStatus" class="text-[11px] text-surface-500 mt-1.5 px-0.5">{% if models %}모델을 선택하세요{% else %}모델을 먼저 다운로드하세요{% endif %}</div>
            </section>

            <!-- Folder Section -->
            <section>
                <label class="block text-[11px] font-medium text-surface-500 uppercase tracking-wider mb-2">문서</label>
                <div class="grid grid-cols-2 gap-1.5 mb-2">
                    <button onclick="browsePath('')" class="py-1.5 px-2 bg-surface-800 border border-surface-700 rounded text-[11px] text-surface-400 hover:text-white hover:border-surface-600 transition-all">드라이브</button>
                    <button onclick="goBack()" class="py-1.5 px-2 bg-surface-800 border border-surface-700 rounded text-[11px] text-surface-400 hover:text-white hover:border-surface-600 transition-all">상위</button>
                    <button onclick="createFolder()" class="py-1.5 px-2 bg-surface-800 border border-surface-700 rounded text-[11px] text-surface-400 hover:text-white hover:border-surface-600 transition-all">+ 폴더</button>
                    <button onclick="goUploadDir()" class="py-1.5 px-2 bg-accent/20 border border-accent/40 rounded text-[11px] text-accent hover:bg-accent/30 transition-all">업로드</button>
                </div>
                
                <input type="file" id="uploadInput" multiple hidden onchange="uploadFiles()">
                <button onclick="document.getElementById('uploadInput').click()" class="w-full py-2 px-3 mb-2 bg-accent hover:bg-accent-hover text-white rounded-lg text-xs font-medium transition-all flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    파일 업로드
                </button>
                
                <div id="folderList" class="bg-surface-800 border border-surface-700 rounded-lg max-h-28 overflow-y-auto mb-2"></div>
                
                <div class="relative mb-2">
                    <input type="text" id="folderPath" placeholder="경로" class="w-full px-3 py-2 pr-8 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 placeholder-surface-500 focus:outline-none focus:border-accent transition-colors">
                    <button onclick="browsePath(document.getElementById('folderPath').value)" class="absolute right-2 top-1/2 -translate-y-1/2 text-surface-500 hover:text-white transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                
                <button onclick="startIndexing()" id="indexBtn" class="w-full py-2 px-4 bg-accent hover:bg-accent-hover text-white rounded-lg text-sm font-medium transition-all">
                    인덱싱
                </button>
                <div id="indexStatus" class="text-[11px] text-surface-500 mt-1.5 px-0.5">폴더 선택 후 인덱싱</div>
            </section>

            <!-- Collection Section -->
            <section>
                <label class="block text-[11px] font-medium text-surface-500 uppercase tracking-wider mb-2">컬렉션</label>
                <select id="collectionSelect" onchange="selectCollection()" class="w-full bg-surface-800 border border-surface-700 rounded-lg px-3 py-2 text-sm text-surface-200 focus:outline-none focus:border-accent transition-colors">
                    <option value="">컬렉션 선택</option>
                    {% for coll in collections %}
                    <option value="{{ coll.name }}">{{ coll.name }} ({{ coll.count }})</option>
                    {% endfor %}
                </select>
                <div id="ragStatus" class="text-[11px] text-surface-500 mt-1.5 px-0.5">모델 + 컬렉션 선택 필요</div>
            </section>

            <!-- Advanced Settings -->
            <section>
                <button onclick="toggleAdvancedSettings()" class="w-full py-2 px-3 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-400 hover:text-white hover:border-surface-600 transition-all flex items-center justify-between">
                    <span>고급 설정</span>
                    <svg id="advancedArrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="advancedSettings" class="hidden mt-2 p-3 bg-surface-800 border border-surface-700 rounded-lg space-y-3">
                    <div>
                        <label class="flex justify-between text-[11px] text-surface-400 mb-1">
                            <span>검색 문서 수</span><span id="kValue">7</span>
                        </label>
                        <input type="range" id="kSlider" min="1" max="20" value="7" class="w-full accent-accent h-1.5" oninput="document.getElementById('kValue').textContent=this.value">
                    </div>
                    <div>
                        <label class="flex justify-between text-[11px] text-surface-400 mb-1">
                            <span>최대 토큰</span><span id="tokenValue">2048</span>
                        </label>
                        <input type="range" id="tokenSlider" min="128" max="8192" step="128" value="2048" class="w-full accent-accent h-1.5" oninput="document.getElementById('tokenValue').textContent=this.value">
                    </div>
                    <div>
                        <label class="flex justify-between text-[11px] text-surface-400 mb-1">
                            <span>창의성</span><span id="tempValue">0.7</span>
                        </label>
                        <input type="range" id="tempSlider" min="0" max="1" step="0.1" value="0.7" class="w-full accent-accent h-1.5" oninput="document.getElementById('tempValue').textContent=this.value">
                    </div>
                    <div>
                        <label class="text-[11px] text-surface-400 mb-1 block">시스템 프롬프트</label>
                        <textarea id="systemPrompt" rows="3" class="w-full px-2.5 py-2 bg-surface-900 border border-surface-700 rounded-lg text-xs text-surface-300 resize-none focus:outline-none focus:border-accent transition-colors">{{ default_system_prompt }}</textarea>
                    </div>
                </div>
            </section>

            <!-- Previous Chats -->
            <section class="flex-1 flex flex-col min-h-0">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-[11px] font-medium text-surface-500 uppercase tracking-wider">이전 대화</label>
                    <button onclick="refreshSessions()" class="text-surface-500 hover:text-white transition-colors" title="새로고침">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                <div id="sessionList" class="flex-1 overflow-y-auto bg-surface-800 border border-surface-700 rounded-lg min-h-[120px] max-h-48">
                    <div class="p-3 text-center text-surface-500 text-xs">로딩 중...</div>
                </div>
            </section>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col min-w-0 bg-surface-950">
        
        <!-- Messages Container -->
        <div id="chatMessages" class="flex-1 overflow-y-auto">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center px-4">
                <div class="w-14 h-14 bg-surface-800 rounded-2xl flex items-center justify-center mb-4 border border-surface-700">
                    <svg class="w-7 h-7 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-white mb-2">Document Assistant</h2>
                <p class="text-surface-400 text-sm max-w-sm leading-relaxed">
                    모델을 로드하고, 문서를 인덱싱한 후<br>컬렉션을 선택하면 질문할 수 있습니다.
                </p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-surface-900 border-t border-surface-800">
            <div class="max-w-4xl mx-auto">
                
                <!-- Attachment Preview -->
                <div id="attachmentPreview" class="hidden flex gap-2 mb-3 flex-wrap"></div>

                <!-- Input Container -->
                <div class="relative bg-surface-900 border border-surface-700 rounded-2xl transition-all duration-200 focus-within:border-accent/50 focus-within:ring-1 focus-within:ring-accent/20">
                    
                    <div class="flex items-end p-2">
                        <!-- Attach Button -->
                        <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf,.docx,.txt,.md" onchange="handleFileSelect(event)" multiple>
                        <button id="attachBtn" onclick="document.getElementById('fileInput').click()" 
                            class="p-2.5 rounded-xl transition-all flex-shrink-0 disabled:cursor-not-allowed text-surface-600 hover:text-surface-400 disabled:text-surface-700 disabled:hover:text-surface-700" 
                            title="비전 모델 필요" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                            </svg>
                        </button>

                        <!-- Textarea -->
                        <textarea id="chatInput" rows="1" 
                            class="chat-textarea flex-1 bg-transparent text-surface-100 placeholder-surface-500 px-3 py-2.5 text-[15px] min-h-[44px] max-h-[168px]" 
                            placeholder="무엇이든 물어보세요..."
                            onkeydown="handleInputKeydown(event)"
                            oninput="autoResize(this)"></textarea>

                        <!-- Send Button -->
                        <button id="sendBtn" onclick="sendChat()" 
                            class="p-2.5 bg-accent hover:bg-accent-hover text-white rounded-xl transition-all flex-shrink-0 disabled:bg-surface-700 disabled:text-surface-500 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                </div>

                <p class="text-center mt-2.5 text-[11px] text-surface-600">AI는 실수를 할 수 있습니다. 중요한 정보는 확인하세요.</p>
            </div>
        </div>
    </main>

    <!-- Model Manager Modal -->
    <div id="modelModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-surface-900 rounded-2xl w-[560px] max-h-[75vh] overflow-hidden flex flex-col border border-surface-700 shadow-2xl animate-slideIn">
            <div class="p-4 border-b border-surface-700 flex justify-between items-center">
                <h3 class="font-semibold text-white">모델 관리</h3>
                <button onclick="closeModelManager()" class="text-surface-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-4 border-b border-surface-800">
                <input type="text" id="modelSearchInput" placeholder="모델 검색..." 
                    class="w-full px-3 py-2.5 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 placeholder-surface-500 focus:outline-none focus:border-accent transition-colors" 
                    onkeyup="searchModels(this.value)">
            </div>
            <div id="modelList" class="flex-1 overflow-y-auto p-2 max-h-[380px]"></div>
            <div class="p-3 border-t border-surface-800 bg-surface-950 text-[11px] text-surface-500 text-center">
                [V] = 비전 모델 (이미지 분석 지원)
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-surface-900 rounded-2xl w-[380px] overflow-hidden border border-surface-700 shadow-2xl animate-slideIn">
            <div class="p-5 border-b border-surface-700 flex justify-between items-center">
                <h3 class="font-semibold text-white">로그인</h3>
                <button onclick="closeLoginModal()" class="text-surface-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-surface-700">
                <button onclick="switchAuthTab('login')" id="loginTab" class="flex-1 py-3 text-sm font-medium text-white bg-surface-800/50 border-b-2 border-accent">로그인</button>
                <button onclick="switchAuthTab('register')" id="registerTab" class="flex-1 py-3 text-sm font-medium text-surface-400 hover:text-white transition-colors border-b-2 border-transparent">회원가입</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="p-5 space-y-4">
                <div>
                    <label class="block text-[11px] font-medium text-surface-400 mb-1.5">아이디</label>
                    <input type="text" id="loginUsername" placeholder="아이디 입력" 
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 placeholder-surface-500 focus:outline-none focus:border-accent transition-colors">
                </div>
                <div>
                    <label class="block text-[11px] font-medium text-surface-400 mb-1.5">비밀번호</label>
                    <input type="password" id="loginPassword" placeholder="비밀번호 입력" 
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 placeholder-surface-500 focus:outline-none focus:border-accent transition-colors">
                </div>
                <div id="loginError" class="hidden text-red-400 text-xs"></div>
                <button onclick="doLogin()" class="w-full py-2.5 bg-accent hover:bg-accent-hover text-white rounded-lg font-medium transition-all">
                    로그인
                </button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden p-5 space-y-4">
                <div>
                    <label class="block text-[11px] font-medium text-surface-400 mb-1.5">아이디</label>
                    <input type="text" id="regUsername" placeholder="아이디 (영문, 숫자)" 
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 placeholder-surface-500 focus:outline-none focus:border-accent transition-colors">
                </div>
                <div>
                    <label class="block text-[11px] font-medium text-surface-400 mb-1.5">비밀번호</label>
                    <input type="password" id="regPassword" placeholder="비밀번호" 
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 placeholder-surface-500 focus:outline-none focus:border-accent transition-colors">
                </div>
                <div>
                    <label class="block text-[11px] font-medium text-surface-400 mb-1.5">비밀번호 확인</label>
                    <input type="password" id="regPasswordConfirm" placeholder="비밀번호 다시 입력" 
                        class="w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-lg text-sm text-surface-200 placeholder-surface-500 focus:outline-none focus:border-accent transition-colors">
                </div>
                <div id="registerError" class="hidden text-red-400 text-xs"></div>
                <button onclick="doRegister()" class="w-full py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-lg font-medium transition-all">
                    회원가입
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentPath = '';
        let modelLoaded = false;
        let ragReady = false;
        let currentSessionId = null;
        let attachments = [];
        let abortController = null;
        let lastFailedQuestion = null;

        document.addEventListener('DOMContentLoaded', () => {
            browsePath('');
            refreshSessions();
        });

        // === Input Handling ===
        function autoResize(el) {
            el.style.height = 'auto';
            const lineHeight = 24;
            const minHeight = 44;
            const maxLines = 6;
            const maxHeight = lineHeight * maxLines + 20;
            
            const newHeight = Math.min(Math.max(el.scrollHeight, minHeight), maxHeight);
            el.style.height = newHeight + 'px';
            
            // Show/hide scrollbar
            el.style.overflowY = el.scrollHeight > maxHeight ? 'auto' : 'hidden';
        }

        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChat();
            }
        }

        // === Folder Navigation ===
        async function browsePath(path) {
            try {
                const res = await fetch('/api/browse?path=' + encodeURIComponent(path));
                const data = await res.json();
                if (data.error) return;
                
                currentPath = data.current;
                document.getElementById('folderPath').value = currentPath;
                
                const list = document.getElementById('folderList');
                if (!data.items || data.items.length === 0) {
                    list.innerHTML = '<div class="p-3 text-center text-surface-500 text-xs">빈 폴더</div>';
                    return;
                }
                
                list.innerHTML = data.items.map(item => {
                    const showActions = item.can_delete;
                    const actionBtns = showActions ? `
                        <button onclick="event.stopPropagation(); renameItem('${item.path.replace(/\\/g, '\\\\')}', '${item.name}')" 
                            class="p-1 hover:bg-accent/20 rounded text-surface-500 hover:text-accent transition-colors" title="이름 변경">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        </button>
                        <button onclick="event.stopPropagation(); deleteItem('${item.path.replace(/\\/g, '\\\\')}', '${item.name}')" 
                            class="p-1 hover:bg-red-500/20 rounded text-surface-500 hover:text-red-400 transition-colors" title="삭제">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    ` : '';
                    
                    if (item.is_dir) {
                        return `<div class="px-3 py-2 hover:bg-surface-700 cursor-pointer text-xs text-surface-300 flex items-center gap-2 border-b border-surface-700/50 last:border-0" onclick="browsePath('${item.path.replace(/\\/g, '\\\\')}')">
                            <svg class="w-4 h-4 text-yellow-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                            <span class="truncate flex-1">${item.name}</span>
                            <div class="flex gap-0.5">${actionBtns}</div>
                        </div>`;
                    } else {
                        return `<div class="px-3 py-2 hover:bg-surface-700 text-xs text-surface-400 flex items-center gap-2 border-b border-surface-700/50 last:border-0">
                            <svg class="w-4 h-4 text-surface-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <span class="truncate flex-1">${item.name}</span>
                            <span class="text-[10px] text-surface-600">${formatSize(item.size)}</span>
                            <div class="flex gap-0.5">${actionBtns}</div>
                        </div>`;
                    }
                }).join('');
            } catch (e) { console.error(e); }
        }

        function formatSize(bytes) {
            if (!bytes) return '';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        async function createFolder() {
            if (!currentPath) { alert('폴더를 먼저 선택하세요'); return; }
            const name = prompt('새 폴더 이름:');
            if (!name) return;
            try {
                const form = new FormData();
                form.append('path', currentPath);
                form.append('name', name);
                const res = await fetch('/api/mkdir', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success) browsePath(currentPath);
                else alert('실패: ' + data.error);
            } catch (e) { alert('오류: ' + e.message); }
        }

        function goBack() {
            if (!currentPath) return;
            let parent = currentPath.replace(/[\\/][^\\/]+[\\/]?$/, '');
            if (parent.match(/^[A-Za-z]:$/)) parent += '/';
            if (!parent || parent === currentPath) browsePath('');
            else browsePath(parent);
        }

        async function goUploadDir() {
            try {
                const res = await fetch('/api/go-upload-dir', { method: 'POST' });
                const data = await res.json();
                if (data.path) browsePath(data.path);
            } catch (e) { console.error(e); }
        }

        async function deleteItem(path, name) {
            if (!confirm(`"${name}"을(를) 삭제하시겠습니까? 복구할 수 없습니다.`)) return;
            try {
                const form = new FormData();
                form.append('path', path);
                const res = await fetch('/api/delete-item', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success) browsePath(currentPath);
                else alert('실패: ' + data.error);
            } catch (e) { alert('오류: ' + e.message); }
        }

        async function renameItem(path, oldName) {
            const newName = prompt(`"${oldName}"의 새 이름:`, oldName);
            if (!newName || newName === oldName) return;
            try {
                const form = new FormData();
                form.append('path', path);
                form.append('new_name', newName);
                const res = await fetch('/api/rename-item', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success) browsePath(currentPath);
                else alert('실패: ' + data.error);
            } catch (e) { alert('오류: ' + e.message); }
        }

        // === Model Management ===
        async function loadModel() {
            const name = document.getElementById('modelSelect').value;
            if (!name) return;

            const status = document.getElementById('modelStatus');
            status.className = 'text-[11px] text-yellow-500 mt-1.5 px-0.5 animate-pulse-subtle';
            status.textContent = '로딩 중... (1-2분)';

            try {
                const form = new FormData();
                form.append('model_name', name);
                const res = await fetch('/api/load-model', { method: 'POST', body: form });
                const data = await res.json();

                if (data.error) {
                    status.className = 'text-[11px] text-red-400 mt-1.5 px-0.5';
                    status.textContent = data.error;
                } else {
                    status.className = 'text-[11px] text-green-400 mt-1.5 px-0.5';
                    status.textContent = '로드 완료!';
                    modelLoaded = true;
                    updateAttachButton();
                    trySetupRag();
                }
            } catch (e) {
                status.className = 'text-[11px] text-red-400 mt-1.5 px-0.5';
                status.textContent = e.message;
            }
        }

        // === Indexing ===
        async function startIndexing() {
            const folder = document.getElementById('folderPath').value;
            if (!folder) { alert('Select a folder'); return; }

            const status = document.getElementById('indexStatus');
            const btn = document.getElementById('indexBtn');

            status.className = 'text-[11px] text-yellow-500 mt-1.5 px-0.5 animate-pulse-subtle';
            status.textContent = '인덱싱 중...';
            btn.disabled = true;

            try {
                const form = new FormData();
                form.append('folder_path', folder);
                form.append('collection_name', '');
                const res = await fetch('/api/index', { method: 'POST', body: form });
                const data = await res.json();

                btn.disabled = false;

                if (data.error) {
                    status.className = 'text-[11px] text-red-400 mt-1.5 px-0.5';
                    status.textContent = data.error;
                } else {
                    status.className = 'text-[11px] text-green-400 mt-1.5 px-0.5';
                    const chunks = data.chunks || 0;
                    const deleted = data.deleted_chunks || 0;
                    let info = [];
                    if (chunks > 0) info.push(`+${chunks}`);
                    if (deleted > 0) info.push(`-${deleted}`);
                    status.textContent = `완료! ${data.collection || ''} (${info.join('/') || '변경 없음'})`;
                    refreshCollections();
                }
            } catch (e) {
                btn.disabled = false;
                status.className = 'text-[11px] text-red-400 mt-1.5 px-0.5';
                status.textContent = '오류: ' + e.message;
            }
        }

        async function refreshCollections() {
            try {
                const res = await fetch('/api/collections');
                const data = await res.json();
                const select = document.getElementById('collectionSelect');
                select.innerHTML = '<option value="">컨렉션 선택</option>' +
                    data.collections.map(c => `<option value="${c.name}">${c.name} (${c.count})</option>`).join('');
            } catch (e) { }
        }

        function selectCollection() { trySetupRag(); }

        async function trySetupRag() {
            if (!modelLoaded) {
                document.getElementById('ragStatus').textContent = '모델을 먼저 로드하세요';
                return;
            }
            const collection = document.getElementById('collectionSelect').value;
            if (!collection) {
                document.getElementById('ragStatus').textContent = '컨렉션 선택 필요';
                return;
            }

            const status = document.getElementById('ragStatus');
            status.className = 'text-[11px] text-yellow-500 mt-1.5 px-0.5';
            status.textContent = 'RAG 설정 중...';

            try {
                const form = new FormData();
                form.append('collection_name', collection);
                const res = await fetch('/api/setup-rag', { method: 'POST', body: form });
                const data = await res.json();

                if (data.error) {
                    status.className = 'text-[11px] text-red-400 mt-1.5 px-0.5';
                    status.textContent = data.error;
                } else {
                    status.className = 'text-[11px] text-green-400 mt-1.5 px-0.5';
                    status.textContent = '준비 완료!';
                    ragReady = true;
                }
            } catch (e) {
                status.className = 'text-[11px] text-red-400 mt-1.5 px-0.5';
                status.textContent = '오류: ' + e.message;
            }
        }

        // === Chat ===
        async function sendChat() {
            const btn = document.getElementById('sendBtn');

            if (abortController) {
                abortController.abort();
                abortController = null;
                return;
            }

            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            if (!question) return;

            if (!ragReady) { alert('Setup model and collection first'); return; }

            const messages = document.getElementById('chatMessages');
            const emptyState = document.getElementById('emptyState');
            if (emptyState) emptyState.remove();

            // User message
            messages.innerHTML += `
                <div class="flex justify-end px-6 py-2 animate-slideIn">
                    <div class="max-w-3xl bg-accent text-white px-4 py-3 rounded-2xl rounded-br-sm text-[15px] leading-relaxed">
                        ${escapeHtml(question)}
                    </div>
                </div>`;

            // AI response with thinking area
            const responseId = 'response-' + Date.now();
            const thinkingId = 'thinking-' + Date.now();
            messages.innerHTML += `
                <div class="flex px-6 py-2 group animate-slideIn" id="${responseId}">
                    <div class="w-8 h-8 bg-surface-800 border border-surface-700 rounded-lg flex items-center justify-center text-accent text-xs font-semibold mr-3 flex-shrink-0">AI</div>
                    <div class="max-w-3xl w-full">
                        <!-- Thinking Panel (collapsible) -->
                        <div id="${thinkingId}" class="mb-2 bg-surface-900/50 border border-surface-700/50 rounded-lg overflow-hidden">
                            <button onclick="toggleThinking('${thinkingId}')" class="w-full px-3 py-2 flex items-center justify-between text-xs text-surface-400 hover:text-surface-200 transition-colors">
                                <span class="flex items-center gap-2">
                                    <svg class="w-4 h-4 animate-pulse-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    <span class="thinking-status">추론 중...</span>
                                </span>
                                <svg class="w-4 h-4 thinking-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div class="thinking-content px-3 pb-2 space-y-1 text-xs text-surface-500"></div>
                        </div>
                        <!-- Response -->
                        <div class="bg-surface-800 border border-surface-700 text-surface-200 px-4 py-3 rounded-2xl rounded-bl-sm prose relative">
                            <div class="response-text text-[15px] leading-relaxed"></div>
                            <span class="typing-cursor text-accent">|</span>
                            <button onclick="copyToClipboard(this)" class="absolute top-2 right-2 p-1.5 text-surface-500 hover:text-white bg-surface-900/50 hover:bg-surface-700 rounded-lg opacity-0 group-hover:opacity-100 transition-all" title="복사">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                            </button>
                        </div>
                    </div>
                </div>`;

            input.value = '';
            input.style.height = '44px';
            messages.scrollTop = messages.scrollHeight;

            // Change to stop button
            btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';
            abortController = new AbortController();

            try {
                const form = new FormData();
                form.append('question', question);
                form.append('attachments', JSON.stringify(attachments));

                const options = {
                    k: document.getElementById('kSlider')?.value || 7,
                    num_predict: document.getElementById('tokenSlider')?.value || 2048,
                    temperature: document.getElementById('tempSlider')?.value || 0.7,
                    system_prompt: document.getElementById('systemPrompt')?.value || ''
                };
                form.append('options', JSON.stringify(options));

                attachments = [];
                updateAttachmentPreview();

                const response = await fetch('/api/chat', { method: 'POST', body: form, signal: abortController.signal });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                const responseEl = document.getElementById(responseId);
                const thinkingEl = document.getElementById(thinkingId);
                const thinkingContent = thinkingEl.querySelector('.thinking-content');
                const thinkingStatus = thinkingEl.querySelector('.thinking-status');
                const textEl = responseEl.querySelector('.response-text');
                const cursorEl = responseEl.querySelector('.typing-cursor');
                let sources = [];
                let fullText = '';
                let thinkingSteps = [];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'thinking') {
                                    // 추론 과정 표시
                                    thinkingSteps.push({ step: data.step, detail: data.detail });
                                    thinkingStatus.textContent = data.step;
                                    thinkingContent.innerHTML = thinkingSteps.map(t => 
                                        `<div class="flex items-start gap-2 py-1">
                                            <span class="text-accent">•</span>
                                            <div>
                                                <span class="text-surface-300">${escapeHtml(t.step)}</span>
                                                <span class="text-surface-500 ml-1">${escapeHtml(t.detail || '')}</span>
                                            </div>
                                        </div>`
                                    ).join('');
                                    messages.scrollTop = messages.scrollHeight;
                                }
                                else if (data.type === 'thinking_done') {
                                    // 추론 완료 - 패널 접기 준비
                                    thinkingStatus.textContent = `추론 완료 (${thinkingSteps.length}단계)`;
                                    thinkingEl.querySelector('svg.animate-pulse-subtle')?.classList.remove('animate-pulse-subtle');
                                    // 자동으로 접기 (선택적)
                                    // thinkingContent.classList.add('hidden');
                                    // thinkingEl.querySelector('.thinking-chevron')?.classList.add('rotate-180');
                                }
                                else if (data.type === 'token') {
                                    fullText += data.data;
                                    textEl.innerHTML = escapeHtml(fullText);
                                    messages.scrollTop = messages.scrollHeight;
                                }
                                else if (data.type === 'sources') { sources = data.data; }
                                else if (data.type === 'done') {
                                    cursorEl?.remove();
                                    textEl.innerHTML = renderMarkdown(fullText);
                                    if (sources.length > 0) {
                                        const links = sources.map(s => 
                                            `<span class="text-accent hover:underline cursor-pointer" onclick="openFileFolder('${s.path.replace(/\\/g, '\\\\')}')">${s.filename}</span>`
                                        ).join(', ');
                                        textEl.innerHTML += `<div class="mt-3 pt-3 border-t border-surface-700 text-xs text-surface-400">Sources: ${links}</div>`;
                                    }
                                    // 추론 패널 자동 접기
                                    if (thinkingContent && !thinkingContent.classList.contains('hidden')) {
                                        thinkingContent.classList.add('hidden');
                                        thinkingEl.querySelector('.thinking-chevron')?.classList.add('rotate-180');
                                    }
                                    refreshSessions();
                                    lastFailedQuestion = null;
                                }
                                else if (data.type === 'error') {
                                    // 오류 시 복사 버튼 숨기기
                                    responseEl.querySelector('button[onclick*="copyToClipboard"]')?.remove();
                                    textEl.innerHTML = `
                                        <span class="text-red-400">${escapeHtml(data.data)}</span>
                                        <button onclick="retryLastMessage()" class="ml-3 px-3 py-1.5 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 text-sm transition-colors">
                                            다시 시도
                                        </button>`;
                                    cursorEl?.remove();
                                    lastFailedQuestion = question;
                                }
                            } catch (e) { }
                        }
                    }
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    const responseEl = document.getElementById(responseId);
                    if (responseEl) {
                        responseEl.querySelector('.typing-cursor')?.remove();
                        responseEl.querySelector('.response-text').innerHTML += '<span class="text-surface-500 text-sm ml-2">(중단됨)</span>';
                    }
                } else {
                    document.getElementById(responseId)?.remove();
                    messages.innerHTML += `
                        <div class="flex px-6 py-2 animate-slideIn">
                            <div class="w-8 h-8 bg-red-500/20 border border-red-500/30 rounded-lg flex items-center justify-center text-red-400 text-xs font-semibold mr-3 flex-shrink-0">!</div>
                            <div class="max-w-3xl bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-2xl rounded-bl-sm text-sm">
                                ${e.message}
                                <button onclick="retryLastMessage()" class="ml-3 px-3 py-1.5 bg-red-500/20 rounded-lg hover:bg-red-500/30 transition-colors">다시 시도</button>
                            </div>
                        </div>`;
                    lastFailedQuestion = question;
                }
            } finally {
                abortController = null;
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>';
                messages.scrollTop = messages.scrollHeight;
            }
        }

        // === Thinking Panel Toggle ===
        function toggleThinking(thinkingId) {
            const thinkingEl = document.getElementById(thinkingId);
            if (!thinkingEl) return;
            const content = thinkingEl.querySelector('.thinking-content');
            const chevron = thinkingEl.querySelector('.thinking-chevron');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron?.classList.remove('rotate-180');
            } else {
                content.classList.add('hidden');
                chevron?.classList.add('rotate-180');
            }
        }

        function retryLastMessage() {
            if (lastFailedQuestion) {
                document.getElementById('chatInput').value = lastFailedQuestion;
                sendChat();
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function renderMarkdown(text) {
            return typeof marked !== 'undefined' ? marked.parse(text) : escapeHtml(text);
        }

        async function clearChat() {
            try {
                await fetch('/api/clear-chat', { method: 'POST' });
                currentSessionId = null;
                document.getElementById('chatMessages').innerHTML = `
                    <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center px-4">
                        <div class="w-14 h-14 bg-surface-800 rounded-2xl flex items-center justify-center mb-4 border border-surface-700">
                            <svg class="w-7 h-7 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                        </div>
                        <h2 class="text-lg font-semibold text-white mb-2">New Chat</h2>
                        <p class="text-surface-400 text-sm">Enter your question to begin.</p>
                    </div>`;
            } catch (e) { console.error(e); }
        }

        // === Sessions ===
        async function refreshSessions() {
            const list = document.getElementById('sessionList');
            try {
                const res = await fetch('/api/sessions');
                const data = await res.json();

                if (!data.sessions || data.sessions.length === 0) {
                    list.innerHTML = '<div class="p-3 text-center text-surface-500 text-xs">No history</div>';
                    return;
                }

                currentSessionId = data.current_session_id;

                list.innerHTML = data.sessions.map(s => `
                    <div class="session-item px-3 py-2.5 cursor-pointer border-b border-surface-700/50 last:border-0 flex items-center gap-2 ${s.id === currentSessionId ? 'active' : ''}" onclick="loadSession('${s.id}')">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm text-surface-200 truncate">${escapeHtml(s.title)}</div>
                            <div class="text-[10px] text-surface-500">${s.updated_at}</div>
                        </div>
                        <button onclick="event.stopPropagation();deleteSessionItem('${s.id}')" class="text-surface-600 hover:text-red-400 p-1 transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<div class="p-3 text-center text-red-400 text-xs">Error loading</div>';
            }
        }

        async function loadSession(sessionId) {
            try {
                const res = await fetch('/api/sessions/' + sessionId);
                const data = await res.json();
                if (!data.session) return;

                currentSessionId = sessionId;
                const messages = document.getElementById('chatMessages');
                messages.innerHTML = '';

                for (const m of data.messages) {
                    if (m.role === 'user') {
                        messages.innerHTML += `
                            <div class="flex justify-end px-6 py-2">
                                <div class="max-w-3xl bg-accent text-white px-4 py-3 rounded-2xl rounded-br-sm text-[15px]">
                                    ${escapeHtml(m.content)}
                                </div>
                            </div>`;
                    } else {
                        let sourcesHtml = '';
                        if (m.sources?.length > 0) {
                            const links = m.sources.map(s => 
                                `<span class="text-accent hover:underline cursor-pointer" onclick="openFileFolder('${s.path.replace(/\\/g, '\\\\')}')">${s.filename}</span>`
                            ).join(', ');
                            sourcesHtml = `<div class="mt-3 pt-3 border-t border-surface-700 text-xs text-surface-400">참조: ${links}</div>`;
                        }
                        messages.innerHTML += `
                            <div class="flex px-6 py-2 group">
                                <div class="w-8 h-8 bg-surface-800 border border-surface-700 rounded-lg flex items-center justify-center text-accent text-xs font-semibold mr-3 flex-shrink-0">AI</div>
                                <div class="max-w-3xl bg-surface-800 border border-surface-700 text-surface-200 px-4 py-3 rounded-2xl rounded-bl-sm prose relative">
                                    <div class="response-text text-[15px]">${renderMarkdown(m.content)}</div>
                                    ${sourcesHtml}
                                    <button onclick="copyToClipboard(this)" class="absolute top-2 right-2 p-1.5 text-surface-500 hover:text-white bg-surface-900/50 hover:bg-surface-700 rounded-lg opacity-0 group-hover:opacity-100 transition-all" title="복사">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                    </button>
                                </div>
                            </div>`;
                    }
                }
                messages.scrollTop = messages.scrollHeight;
                refreshSessions();
            } catch (e) { console.error(e); }
        }

        async function deleteSessionItem(sessionId) {
            if (!confirm('이 대화를 삭제하시겠습니까?')) return;
            try {
                await fetch('/api/sessions/' + sessionId, { method: 'DELETE' });
                if (sessionId === currentSessionId) { currentSessionId = null; clearChat(); }
                refreshSessions();
            } catch (e) { console.error(e); }
        }

        // === Attachments ===
        async function handleFileSelect(event) {
            const files = event.target.files;
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        attachments.push({ type: 'image', name: file.name, data: e.target.result.split(',')[1], preview: e.target.result });
                        updateAttachmentPreview();
                    };
                    reader.readAsDataURL(file);
                } else {
                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        const res = await fetch('/api/extract-text', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (data.text) {
                            attachments.push({ type: 'document', name: file.name, data: data.text });
                            updateAttachmentPreview();
                        }
                    } catch (e) { console.error('File processing failed:', e); }
                }
            }
            event.target.value = '';
        }

        function updateAttachmentPreview() {
            const preview = document.getElementById('attachmentPreview');
            if (attachments.length === 0) { preview.classList.add('hidden'); return; }
            preview.classList.remove('hidden');
            preview.innerHTML = attachments.map((a, i) => {
                if (a.type === 'image') {
                    return `<div class="relative"><img src="${a.preview}" class="h-12 rounded-lg border border-surface-700"><button onclick="removeAttachment(${i})" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] flex items-center justify-center">x</button></div>`;
                }
                return `<div class="relative px-3 py-2 bg-surface-800 border border-surface-700 rounded-lg text-xs text-surface-300">${a.name}<button onclick="removeAttachment(${i})" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] flex items-center justify-center">x</button></div>`;
            }).join('');
        }

        function removeAttachment(i) { attachments.splice(i, 1); updateAttachmentPreview(); }

        function getCurrentModelIsVision() {
            const select = document.getElementById('modelSelect');
            const option = select.options[select.selectedIndex];
            return option && option.dataset.vision === 'true';
        }

        function updateAttachButton() {
            const btn = document.getElementById('attachBtn');
            const isVision = getCurrentModelIsVision();
            btn.disabled = !isVision;
            if (isVision) {
                btn.className = 'p-2.5 rounded-xl transition-all flex-shrink-0 text-accent hover:text-accent-hover hover:bg-accent/10';
                btn.title = '파일 첨부';
            } else {
                btn.className = 'p-2.5 rounded-xl transition-all flex-shrink-0 disabled:cursor-not-allowed text-surface-600 hover:text-surface-400 disabled:text-surface-700 disabled:hover:text-surface-700';
                btn.title = '비전 모델 필요';
            }
        }

        // === Model Manager ===
        function openModelManager() {
            document.getElementById('modelModal').classList.remove('hidden');
            searchModels('');
        }

        function closeModelManager() {
            document.getElementById('modelModal').classList.add('hidden');
        }

        async function searchModels(query) {
            const list = document.getElementById('modelList');
            list.innerHTML = '<div class="text-center py-8 text-surface-500">검색 중...</div>';
            try {
                const res = await fetch('/api/models/search?q=' + encodeURIComponent(query));
                const data = await res.json();
                if (!data.models?.length) { list.innerHTML = '<div class="text-center py-8 text-surface-500">결과 없음</div>'; return; }
                list.innerHTML = data.models.map(m => `
                    <div class="flex items-center p-3 rounded-lg hover:bg-surface-800 transition-colors">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-white text-sm truncate">${m.name} ${m.vision ? '<span class="text-purple-400">[V]</span>' : ''}</div>
                            <div class="text-xs text-surface-500 truncate">${m.description || ''} (${m.size})</div>
                        </div>
                        ${m.installed
                            ? `<button onclick="deleteModel('${m.name}')" class="px-3 py-1.5 bg-red-500/20 text-red-400 rounded-lg text-xs hover:bg-red-500/30 transition-colors">삭제</button>`
                            : `<button onclick="pullModel('${m.name}')" class="px-3 py-1.5 bg-accent text-white rounded-lg text-xs hover:bg-accent-hover transition-colors" id="pull-${m.name.replace(/[:.]/g, '_')}">다운로드</button>`
                        }
                    </div>
                `).join('');
            } catch (e) { list.innerHTML = '<div class="text-center py-8 text-red-400">Error: ' + e.message + '</div>'; }
        }

        async function pullModel(modelName) {
            const btnId = 'pull-' + modelName.replace(/[:.]/g, '_');
            const btn = document.getElementById(btnId);
            if (btn) { btn.disabled = true; btn.textContent = '다운로드 중...'; }
            try {
                const form = new FormData();
                form.append('model_name', modelName);
                const response = await fetch('/api/models/pull', { method: 'POST', body: form });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    for (const line of chunk.split('\n')) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (btn) btn.textContent = data.progress > 0 ? data.progress + '%' : (data.status || '준비 중...');
                                if (data.status === 'success' || data.status === 'error') break;
                            } catch (e) {}
                        }
                    }
                }
                if (btn) { btn.textContent = '완료!'; btn.className = 'px-3 py-1.5 bg-green-500 text-white rounded-lg text-xs'; }
                await refreshModelSelect();
                setTimeout(() => searchModels(document.getElementById('modelSearchInput').value), 500);
            } catch (e) { if (btn) { btn.textContent = '실패'; btn.className = 'px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs'; } }
        }

        async function deleteModel(modelName) {
            if (!confirm(`"${modelName}" 모델을 삭제하시겠습니까?`)) return;
            try {
                const res = await fetch('/api/models/' + encodeURIComponent(modelName), { method: 'DELETE' });
                if (res.ok) { await refreshModelSelect(); searchModels(document.getElementById('modelSearchInput').value); }
                else alert('삭제 실패');
            } catch (e) { alert('오류: ' + e.message); }
        }

        async function refreshModelSelect() {
            try {
                const res = await fetch('/api/models/installed');
                const data = await res.json();
                const select = document.getElementById('modelSelect');
                const currentValue = select.value;
                select.innerHTML = data.models.length > 0 ? '<option value="">모델 선택</option>' : '<option value="">모델 없음</option>';
                data.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.name;
                    opt.textContent = `${m.name} (${m.size})${m.is_vision ? ' [V]' : ''}`;
                    opt.dataset.vision = m.is_vision;
                    select.appendChild(opt);
                });
                if (currentValue) select.value = currentValue;
            } catch (e) { console.error(e); }
        }

        // === Utilities ===
        function toggleAdvancedSettings() {
            const panel = document.getElementById('advancedSettings');
            const arrow = document.getElementById('advancedArrow');
            panel.classList.toggle('hidden');
            arrow.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        async function openFileFolder(path) {
            try {
                const form = new FormData();
                form.append('path', path);
                const res = await fetch('/api/open-folder', { method: 'POST', body: form });
                const data = await res.json();
                if (data.error) alert('실패: ' + data.error);
            } catch (e) { console.error(e); }
        }

        function copyToClipboard(btn) {
            const container = btn.closest('.prose, .message-content');
            const textEl = container.querySelector('.response-text');
            const text = textEl ? textEl.innerText : container.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML = '<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                setTimeout(() => btn.innerHTML = original, 2000);
            });
        }

        async function uploadFiles() {
            const input = document.getElementById('uploadInput');
            if (!input.files.length) return;
            const form = new FormData();
            for (let file of input.files) form.append('files', file);
            if (currentPath) form.append('target_path', currentPath);
            try {
                document.getElementById('indexStatus').textContent = '업로드 중...';
                const res = await fetch('/api/upload-files', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success) { document.getElementById('indexStatus').textContent = '업로드 완료'; browsePath(data.upload_dir); }
                else alert('업로드 실패: ' + data.error);
            } catch (e) { alert('오류: ' + e.message); }
            input.value = '';
        }

        async function logout() {
            try { await fetch('/api/logout', { method: 'POST' }); location.reload(); }
            catch (e) { console.error(e); }
        }

        // === Auth Modal ===
        function openLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
        function closeLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            if (tab === 'login') {
                loginTab.className = 'flex-1 py-3 text-sm font-medium text-white bg-surface-800/50 border-b-2 border-accent';
                registerTab.className = 'flex-1 py-3 text-sm font-medium text-surface-400 hover:text-white transition-colors border-b-2 border-transparent';
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginTab.className = 'flex-1 py-3 text-sm font-medium text-surface-400 hover:text-white transition-colors border-b-2 border-transparent';
                registerTab.className = 'flex-1 py-3 text-sm font-medium text-white bg-surface-800/50 border-b-2 border-accent';
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
        }

        async function doLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            if (!username || !password) { errorDiv.textContent = '아이디와 비밀번호를 입력하세요'; errorDiv.classList.remove('hidden'); return; }
            try {
                const form = new FormData();
                form.append('username', username);
                form.append('password', password);
                const res = await fetch('/api/login', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success) location.reload();
                else { errorDiv.textContent = data.error || '로그인 실패'; errorDiv.classList.remove('hidden'); }
            } catch (e) { errorDiv.textContent = '서버 오류'; errorDiv.classList.remove('hidden'); }
        }

        async function doRegister() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regPasswordConfirm').value;
            const errorDiv = document.getElementById('registerError');
            if (!username || !password || !confirm) { errorDiv.textContent = '모든 필드를 입력하세요'; errorDiv.classList.remove('hidden'); return; }
            if (password !== confirm) { errorDiv.textContent = '비밀번호가 일치하지 않습니다'; errorDiv.classList.remove('hidden'); return; }
            try {
                const form = new FormData();
                form.append('username', username);
                form.append('password', password);
                const res = await fetch('/api/register', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success) { alert('가입 완료! 로그인 해주세요.'); switchAuthTab('login'); document.getElementById('loginUsername').value = username; }
                else { errorDiv.textContent = data.error || '가입 실패'; errorDiv.classList.remove('hidden'); }
            } catch (e) { errorDiv.textContent = '서버 오류'; errorDiv.classList.remove('hidden'); }
        }

        // Close modals on outside click
        document.getElementById('loginModal').addEventListener('click', e => { if (e.target === document.getElementById('loginModal')) closeLoginModal(); });
        document.getElementById('modelModal').addEventListener('click', e => { if (e.target === document.getElementById('modelModal')) closeModelManager(); });
    </script>
</body>
</html>
